<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Bi</title>
		<style>
			* {
				box-sizing: border-box;
			}
			html,body {
				width: 100%;
				height: 100%;
			}
			body {
				margin: 0;
			}
			#canvas-wrapper {
				width: 100%;
				height: 100%;
				background-image: linear-gradient(blue, black, blue);
				outline: none;
			}
			#canvas {
				width: 100%;
				height: 100%;
			}
			#menu {
				position: absolute;
				top: 0px;
				right: 0px;
				z-index: 123123123;
				background-color: white;
				font-family: monospace;
			}
			#hand {
				position: absolute;
				bottom: 0px;
				right: 0px;
				width: 20%;
				height: 40%;
				pointer-events: none;
			}
			input[type="range"] {
				width: 300px;
			}
		</style>
	</head>
	<body>
		<div id="canvas-wrapper" tabindex="0" onkeydown="keysDown[event.key] = true;" onkeyup="keysDown[event.key] = false;">
			<canvas id="canvas"></canvas>
		</div>
		<img src="https://lh3.googleusercontent.com/QvP1N362ZFW4JRo1OuowIFpcyv-bcLmJ14dia3p6xF0J3MEAlFHzay4mWKmeUfrRoza9v6rd3Ci7XKb267f5=s500" alt="hand" id="hand">
		<div id="menu">
			<label for="fov">fov:</label><input type="number" id="fov" min="1" max="360" value="90"><br>
			<label for="res">res:</label><input type="number" id="res" min="1" max="360" value="180"><br>
			<label>fps: </label> <label id="fps"></label><br>
			<input type="checkbox" id="show-rays"><label for="show-rays">show rays</label>
		</div>
	</body>
	<script>
		const canvas = document.getElementById("canvas");
		canvas.width = innerWidth;
		canvas.height = innerHeight;
		const ctx = canvas.getContext("2d");
		const levelData = [];
		var lastTimer = 0;
		var fps = 0;
		var fov = 90;
		var res = 90;
		var keysDown = {};
		ctx.fillStyle = "rgba(255, 0, 0, 1)";
		ctx.lineWidth = canvas.width / res;

		function getPixel(x, y) {
			return levelData[Math.round(x) + (Math.round(y) * canvas.width)];
		};
		function drawLine(first, second) {
			ctx.beginPath();
			ctx.moveTo(first[0], first[1]);
			ctx.lineTo(second[0], second[1]);
			ctx.stroke();
		};
		function distance(p1, p2) {
			return Math.sqrt(((p1[0] - p2[0]) ** 2) + ((p1[1] - p2[1]) ** 2));
		};
		function isDown(key) {
			return keysDown[key] ?? false;
		};

		function draw() {
			ctx.fillStyle = "rgba(255, 0, 0, 1)";
			ctx.fillRect(50, 50, 100, 100);

			ctx.fillStyle = "rgba(0, 0, 255, 1)";
			ctx.fillRect(0, 0, canvas.width, 10);
			ctx.fillRect(0, 10, 10, canvas.height);
			ctx.fillRect(canvas.width - 10, 0, 10, canvas.height);
			ctx.fillRect(0, canvas.height - 10, canvas.width, 10);

			ctx.fillStyle = "rgba(0, 255, 0, 1)";
			ctx.fillRect(200, 200, 20, 20);
			ctx.fillRect(240, 200, 20, 20);
			ctx.fillRect(280, 200, 20, 20);
			ctx.fillRect(200, 240, 20, 20);
			ctx.fillRect(240, 240, 20, 20);
			ctx.fillRect(280, 240, 20, 20);
			ctx.fillRect(200, 280, 20, 20);
			ctx.fillRect(240, 280, 20, 20);
			ctx.fillRect(280, 280, 20, 20);

			ctx.fillStyle = "rgba(255, 255, 0, 1)";
			ctx.beginPath();
			ctx.arc(500, 300, 50, 0, 2 * Math.PI);
			ctx.fill();

			ctx.fillStyle = "rgba(255, 0, 0, 1)";
			ctx.fillRect(700, 500, 50, 50);
			ctx.fillRect(750, 550, 50, 50);
			ctx.fillStyle = "rgba(255, 0, 255, 1)";
			ctx.fillRect(750, 500, 50, 50);
			ctx.fillRect(700, 550, 50, 50);
			
		};
		function colliding(x, y) {
			return (getPixel(x, y) ?? [0, 0, 0, 255])[3] !== 0;
		};
		draw();

		(() => {
			let data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
			for (let i = 0; i < data.length; i += 4) {
				levelData.push([data[i], data[i+1], data[i+2], data[i+3]])
			};
		})();
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		var playerX = 300;
		var playerY = 400;
		var playerDir = 0;

		function render() {
			fov = document.getElementById("fov").value;
			res = document.getElementById("res").value;

			let turnSpeed = 100 / (fps || 1);
			playerDir += (isDown("ArrowLeft") - isDown("ArrowRight")) * turnSpeed;

			let oldPlayerX = playerX;
			let oldPlayerY = playerY;

			let speed = 100 / (fps || 1);
			//straight
			playerX += Math.sin(playerDir * (Math.PI / 180)) * ((isDown("ArrowUp") || isDown("w")) - (isDown("ArrowDown") || isDown("s"))) * speed;
			if (colliding(playerX, playerY)) {
				playerX = oldPlayerX;
			};
			playerY += Math.cos(playerDir * (Math.PI / 180)) * ((isDown("ArrowUp") || isDown("w")) - (isDown("ArrowDown") || isDown("s"))) * speed;
			if (colliding(playerX, playerY)) {
				playerY = oldPlayerY;
			};
			//strafe
			playerX += Math.sin((playerDir + 90) * (Math.PI / 180)) * (isDown("a") - isDown("d")) * speed;
			if (colliding(playerX, playerY)) {
				playerX = oldPlayerX;
			};
			playerY += Math.cos((playerDir + 90) * (Math.PI / 180)) * (isDown("a") - isDown("d")) * speed;
			if (colliding(playerX, playerY)) {
				playerY = oldPlayerY;
			};

			let rayHits = [];
			for (let i = 0; i < fov; i += fov/res) {
				let xv = Math.sin(((playerDir - (fov / 2)) + i) * (Math.PI / 180)) * 1;
				let yv = Math.cos(((playerDir - (fov / 2)) + i) * (Math.PI / 180)) * 1;
				let rayx = playerX;
				let rayy = playerY;
				while ((getPixel(rayx, rayy) ?? [0, 0, 0, 0])[3] == 0 && (rayx > 0 && rayy > 0 && rayx < canvas.width && rayy < canvas.height)) {
					rayx += xv;
					rayy += yv;
				};
				let color = getPixel(rayx, rayy);
				rayx -= xv;
				rayy -= yv;
				rayHits.push({
					x: rayx,
					y: rayy,
					distance: distance([playerX, playerY], [rayx, rayy]),
					color: color
				});
			};
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			rayHits.reverse();
			rayHits.forEach((point, pos) => {
				ctx.strokeStyle = `rgba(${point.color[0]}, ${point.color[1]}, ${point.color[2]}, ${1 - (point.distance / 1000)})`;
				let lineX = (pos * (canvas.width / res)) + (ctx.lineWidth / 2);
				let height = 15000 / point.distance;
				ctx.lineWidth = (canvas.width / res) + 0.3;
				drawLine([lineX, (canvas.height / 2) - height], [lineX, (canvas.height / 2) + height]);
			});


			draw();
			if (document.getElementById("show-rays").checked) {
				rayHits.forEach((point, pos) => {
					ctx.strokeStyle = `rgba(255, 255, 0, 0.1)`;
					ctx.lineWidth = 5;
					drawLine([playerX, playerY], [point.x, point.y]);
				});
			};

			fps = Math.round(1000 / (Date.now() - lastTimer));
			document.getElementById("fps").innerHTML = fps;
			lastTimer = Date.now();
		};
		setInterval(render, 10);
	</script>
</html>
