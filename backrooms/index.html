<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Boffnop</title>
		<style>
			* {
				box-sizing: border-box;
			}
			html,body {
				width: 100%;
				height: 100%;
			}
			body {
				margin: 0;
				overflow: hidden;
			}
			#canvas-wrapper {
				width: 100%;
				height: 100%;
				outline: none;
			}
			#canvas {
				width: 100%;
				height: 100%;
			}
			#settings {
				background-color: white;
				position: absolute;
				top: 0px;
				right: 0px;
				z-index: 19;
				font-family: monospace;
			}
			input {
				width: 200px;
			}
		</style>
	</head>
	<body>
		<div id="canvas-wrapper" tabindex="0" onkeydown="keysDown[event.key] = true; if (event.key == ' ') {renderreal()}" onkeyup="keysDown[event.key] = false;">
			<canvas id="canvas"></canvas>
		</div>
		<div id="settings">
			<label for="fovX">fovX:</label><input type="range" id="fovX" min="0" max="360" value="90"><br>
			<label for="fovY">fovY:</label><input type="range" id="fovY" min="0" max="360" value="90">
		</div>
	</body>
	<script>
		const canvas = document.getElementById("canvas");
		canvas.width = innerWidth;
		canvas.height = innerHeight;
		const ctx = canvas.getContext("2d");

		var fovX = 130;
		var fovY = 100;
		var resX = fovX * 0.5;
		var resY = fovY * 0.5;
		var playerX = 0;
		var playerY = 0;
		var playerZ = 0;
		var playerDirX = 0;
		var playerDirY = 0;
		var keysDown = {};

		function isDown(key) {
			return keysDown[key] ?? false;
		};
		function getPixel(x, y, z) {
			/*
				x: red
				y: green
				z: blue
			*/
			if (x > 200 || x < -200) {
				return [255, 0, 0, 1];
			};
			if (y > 200 || y < -200) {
				return [0, 255, 0, 1];
			};
			if (z > 200 || z < -200) {
				return [0, 0, 255, 1];
			};
			return [0, 0, 0, 0];
		};
		function deg2rad(degrees) {
			return degrees * (Math.PI / 180);
		};
		function render() {
			let time = Date.now();

			if (fovX != document.getElementById("fovX").value) {
				fovX = document.getElementById("fovX").value;
			};
			if (fovY != document.getElementById("fovY").value) {
				fovY = document.getElementById("fovY").value;
			};

			playerDirY += (isDown("ArrowRight") - isDown("ArrowLeft"));
			playerDirX += (isDown("ArrowDown") - isDown("ArrowUp"));

			playerZ += (isDown("w") - isDown("s")) * Math.sin(deg2rad(playerDirY));
			playerX += (isDown("w") - isDown("s")) * Math.cos(deg2rad(playerDirY));
			
			playerZ += (isDown("a") - isDown("d")) * Math.sin(deg2rad(playerDirY + 90));
			playerX += (isDown("a") - isDown("d")) * Math.cos(deg2rad(playerDirY + 90));
			
			ctx.clearRect(0, 0, canvas.width, canvas.height);

			for (let pixelX = 0; pixelX < canvas.width; pixelX += canvas.width / resX) {
				for (let pixelY = 0; pixelY < canvas.height; pixelY += canvas.height / resY) {
					let rayDirX = (pixelY * (fovY / canvas.width)) + playerDirX;
					let rayDirY = (pixelX * (fovX / canvas.height)) + playerDirY;
					let rayXV = Math.sin(deg2rad(rayDirY)) * Math.cos(deg2rad(rayDirX));
					let rayYV = Math.sin(deg2rad(rayDirX));
					let rayZV = Math.cos(deg2rad(rayDirY)) * Math.cos(deg2rad(rayDirX));
					let rayX = playerX;
					let rayY = playerY;
					let rayZ = playerZ;
					let bpb = 0;
					while (getPixel(rayX, rayY, rayZ)[3] == 0 && bpb < 100900) {
						rayX += rayXV;
						rayY += rayYV;
						rayZ += rayZV;
						bpb++;
					};
					let color = getPixel(rayX, rayY, rayZ);
					ctx.fillStyle = `rgba(${color.join(", ")})`;
					ctx.fillRect(pixelX, pixelY, canvas.width / resX, canvas.height / resY);
				};
			};
			// console.log("render took " + (Math.floor(((Date.now() - time) / 1000) * 10) / 10) + "s");
			return Date.now() - time;
		};
		var bud = setInterval(render, 10);
		function renderreal() {
			clearInterval(bud);
			resX = canvas.width;
			resY = canvas.height;
			render();
		};
	</script>
</html>
