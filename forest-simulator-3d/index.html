<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>forest simulator 3d</title>
		<style>
			* {
				box-sizing: border-box;
			}
			html,body {
				width: 100%;
				height: 100%;
			}
			body {
				margin: 0;
				overflow: hidden;
			}
			#canvas-wrapper,#game,#thing {
				width: 100%;
				height: 100%;
				outline: none;
			}
			#game {
				user-select: none;
			}
			#canvas {
				width: 100%;
				height: 100%;
			}
			#shop-button {
				position: absolute;
				top: 10px;
				right: 10px;
				color: black;
				background-color: white;
				border: 5px solid black;
				border-radius: 5px;
				padding: 10px;
				font-family: Arial, Helvetica, sans-serif;
				font-size: 20px;
			}
			#shop {
				display: none;
				position: absolute;
				left: 50%;
				top: 50%;
				transform: translate(-50%, -50%);
				background-color: white;
				border-radius: 10px;
				border: 5px solid black;
				padding: 5px;
				width: 80%;
				height: calc(100% - 100px);
				overflow: auto;
			}
			#stats {
				margin: 0;
				position: absolute;
				left: 10px;
				top: 2px;
				font-family: Arial, sans-serif;
				color: yellow;
				font-size: 30px;
				text-shadow: 0px 0px 3px black;
			}
			h1,h2,h3,h4 {
				margin: 0;
			}
			#health {
				position: absolute;
				bottom: 0px;
				left: 0px;
				width: 600px;
				height: 50px;
				background-color: black;
			}
			#health-inner {
				width: 600px;
				height: 50px;
				background-color: rgb(0, 255, 0);
			}
			#joystick {
				position: absolute;
				display: flex;
				align-items: center;
				justify-content: center;
				bottom: 100px;
				right: 100px;
				width: 200px;
				height: 200px;
				background-color: gray;
				border-radius: 50%;
				opacity: 0.8;
				display: none;
			}
			#circle-thing {
				width: 50px;
				height: 50px;
				background-color: lightgray;
				border-radius: 50%;
				transform: translate(0px, 0px);
			}
			#shop-coins {
				width: 50%;
				float: left;
			}
			#shop-gems {
				width: 50%;
				float: right;
			}
			#notification {
				font-family: Arial, sans-serif;
				position: absolute;
				font-size: 30px;
				color: yellow;
				bottom: 10%;
				left: 0px;
				width: 100%;
				text-align: center;
				text-shadow: 0px 0px 3px black;
			}
		</style>
	</head>
	<body>
		<div id="thing" tabindex="0" onkeydown="if (event.key == 'Escape') shopButton();">
			<div id="game" tabindex="0" onmouseup="joystick.mouseUp(event);" ontouchend="joystick.mouseUp(event);" onmousemove="joystick.mouseMove(event);" ontouchmove="joystick.mouseMove(event);" oncontextmenu="return false;">
				<div id="canvas-wrapper" tabindex="0" onkeydown="keyDownFunction(event);" onkeyup="keysDown[event.key] = false;">
					<canvas id="canvas"></canvas>
				</div>
				<div id="stats">score: -<br>coins: -</div>
				<button id="shop-button" onclick="shopButton();">SHOP</button>
				<div id="health">
					<div id="health-inner"></div>
				</div>
				<div id="joystick" onmousedown="joystick.mouseDown(event);" ontouchstart="joystick.mouseDown(event);"><div id="circle-thing"></div></div>
			</div>
			<div id="shop">
				<h1>shop</h1>
				<div id="saves">
					<select id="save-slot-selector">
						<option value="0" selected>slot 0</option>
						<option value="1">slot 1</option>
						<option value="2">slot 2</option>
					</select>
					<button onclick="saveSlot(document.getElementById('save-slot-selector').value);">save</button>
					<button onclick="loadSlot(document.getElementById('save-slot-selector').value);">load</button>
				</div>
				<hr>
				<input type="checkbox" id="joystick-checkbox"><label for="joystick-checkbox">joystick</label><br>
				<input type="checkbox" id="animations-checkbox"><label for="animations-checkbox">animations</label>
				<div id="shop-coins">
					<div id="boots">
						<h3>boots</h3>
						<button onclick="clickShoeButton(this, 'sketchers');">Sketchers (0 coins)</button><br>
						<button onclick="clickShoeButton(this, 'tennis rackets');">Tennis rackets (30 coins)</button><br>
						<button onclick="clickShoeButton(this, 'running shoes');">Running shoes (60 coins)</button><br>
						<button onclick="clickShoeButton(this, 'spring boots');">Spring boots (90 coins)</button><br>
						<button onclick="clickShoeButton(this, 'feather boots');">Feather boots (120 coins)</button><br>
						<button onclick="clickShoeButton(this, 'stepping boots');">Stepping boots (150 coins)</button><br>
						<button onclick="clickShoeButton(this, 'magnet boots');">Magnet boots (170 coins)</button>
					</div><br>
					<div id="food">
						<h3>food</h3><br>
						<label>apple</label><label id="apple-howmany">(0)</label><button onclick="devourFood('apple');">devour</button><button onclick="purchaseFood('apple');">purchase (5 coins)</button><br>
						<label>bread</label><label id="bread-howmany">(0)</label><button onclick="devourFood('bread');">devour</button><button onclick="purchaseFood('bread');">purchase (10 coins)</button><br>
						<label>burger</label><label id="burger-howmany">(0)</label><button onclick="devourFood('burger');">devour</button><button onclick="purchaseFood('burger');">purchase (14 coins)</button><br>
						<label>cold meal</label><label id="cold-meal-howmany">(0)</label><button onclick="devourFood('cold meal');">devour</button><button onclick="purchaseFood('cold meal');">purchase (19 coins)</button><br>
						<label>meal</label><label id="meal-howmany">(0)</label><button onclick="devourFood('meal');">devour</button><button onclick="purchaseFood('meal');">purchase (23 coins)</button><br>
						<label>warm meal</label><label id="warm-meal-howmany">(0)</label><button onclick="devourFood('warm meal');">devour</button><button onclick="purchaseFood('warm meal');">purchase (27 coins)</button><br>
						<label>hot meal</label><label id="hot-meal-howmany">(0)</label><button onclick="devourFood('hot meal');">devour</button><button onclick="purchaseFood('hot meal');">purchase (31 coins)</button><br>
						<label>crispy gooey homemade mac and cheese</label><label id="crispy-gooey-homemade-mac-and-cheese-howmany">(0)</label><button onclick="devourFood('crispy gooey homemade mac and cheese');">devour</button><button onclick="purchaseFood('crispy gooey homemade mac and cheese');">purchase (34 coins)</button><br>
						<label>cow brain</label><label id="cow-brain-howmany">(0)</label><button onclick="devourFood('cow brain');">devour</button><button onclick="purchaseFood('cow brain');">purchase (38 coins)</button><br>
						<label>filling warm meal</label><label id="filling-warm-meal-howmany">(0)</label><button onclick="devourFood('filling warm meal');">devour</button><button onclick="purchaseFood('filling warm meal');">purchase (41 coins)</button>
					</div><br>
					<div id="stuff">
						<h3>stuff</h3><br>
						<label>ladder</label><label id="ladder-howmany">(0)</label><button onclick="placeLadder();">place</button><button onclick="purchaseLadder();">purchase (10 coins)</button><br>
						<label>tall ladder</label><label id="tall-ladder-howmany">(0)</label><button onclick="placeTallLadder();">place</button><button onclick="purchaseTallLadder();">purchase (25 coins)</button>
					</div>
				</div>
				<div id="shop-gems">
					<div id="potions">
						<h3>potions</h3>
						<label>speed potion (10 seconds)</label><label id="speed-potion-howmany">(0)</label><button onclick="chugPotion('speed potion');">chug</button><button onclick="brewPotion('speed potion');">brew (2 gems)</button><br>
						<label>jumping potion (10 seconds)</label><label id="jumping-potion-howmany">(0)</label><button onclick="chugPotion('jumping potion');">chug</button><button onclick="brewPotion('jumping potion');">brew (3 gems)</button><br>
						<label>regeneration potion (10 seconds)</label><label id="regeneration-potion-howmany">(0)</label><button onclick="chugPotion('regeneration potion');">chug</button><button onclick="brewPotion('regeneration potion');">brew (5 gems)</button><br>
						<label>spider potion (10 seconds)</label><label id="spider-potion-howmany">(0)</label><button onclick="chugPotion('spider potion');">chug</button><button onclick="brewPotion('spider potion');">brew (7 gems)</button><br>
						<label>levitation potion (10 seconds)</label><label id="levitation-potion-howmany">(0)</label><button onclick="chugPotion('levitation potion');">chug</button><button onclick="brewPotion('levitation potion');">brew (8 gems)</button><br>
						<label>bird potion (10 seconds)</label><label id="bird-potion-howmany">(0)</label><button onclick="chugPotion('bird potion');">chug</button><button onclick="brewPotion('bird potion');">brew (12 gems)</button>
					</div>
				</div>
			</div>
			<div id="notification">

			</div>
		</div>
	</body>
	<script>
		const canvas = document.getElementById("canvas");
		canvas.width = innerWidth;
		canvas.height = innerHeight;
		const ctx = canvas.getContext("2d");
		document.getElementById("canvas-wrapper").focus();

		class Tree {
			constructor() {
				this
			};
		};

		var keysDown = [];
		function isDown(key) {
			return keysDown[key] ?? false;
		};
		class CanvasImage {
			constructor(color, src) {
				this.image = new Image();
				this.image.src = src;
				this.loaded = false;
				this.color = color;
				let canvasimagething = this;
				this.image.onload = function() {
					canvasimagething.loaded = true;
					imagesLoaded++;
				};
			};
			draw(sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight) {
				ctx.fillStyle = this.color ?? "rgb(255, 0, 255)";
				if (arguments.length == 2) {
					if (this.loaded) {
						ctx.drawImage(this.image, arguments[0], arguments[1]);
					} else {
						ctx.fillRect(arguments[0], arguments[1], 50, 50);
					};
				} else if (arguments.length == 4) {
					if (this.loaded) {
						ctx.drawImage(this.image, arguments[0], arguments[1], arguments[2], arguments[3]);
					} else {
						ctx.fillRect(arguments[0], arguments[1], arguments[2], arguments[3]);
					};
				} else if (arguments.length == 8) {
					if (this.loaded) {
						ctx.drawImage(this.image, arguments[0], arguments[1], arguments[2], arguments[3], arguments[4], arguments[5], arguments[6], arguments[7]);
					} else {
						ctx.fillRect(arguments[4], arguments[5], arguments[6], arguments[7]);
					};
				} else {
					throw new TypeError("image draw 2 4 or 8 things");
				};
			};
		};
		class Joystick {
			constructor(element) {
				this.angle = 0;
				this.strength = 0;
				this.isMouseDown = false;
				this.element = element;
			};
			mouseMove(e) {
				if (!shop) {
					if (e.touches) {
						e = e.touches[0];
					};
					let coords = this.coordinates(e.clientX, e.clientY);
					let rect = this.element.getBoundingClientRect();
					let xy = this.coordinates(rect.x, rect.y);
					if (this.isMouseDown) {
						this.angle = Math.atan2(coords[0], coords[1]) * 180 / Math.PI;
						this.strength = clamp(Math.sqrt((coords[0] - (xy[0] + rect.width / 2)) ** 2 + (coords[1] - (xy[1] + rect.height / 2)) ** 2) / 100, 0, 1);
					};
					this.updateCircle();
				};
			};
			mouseUp(e) {
				if (!shop) {
					if (e.touches) {
						e = e.touches[0];
					};
					this.isMouseDown = false;
					this.angle = 0;
					this.strength = 0;
					this.updateCircle();
				};
			};
			mouseDown(e) {
				if (!shop) {
					if (e.touches) {
						e = e.touches[0];
					};
					this.isMouseDown = true;
					this.mouseMove(e);
				};
			};
			coordinates(x, y) {
				let rect = this.element.getBoundingClientRect();
				return [x - (rect.x + rect.width / 2), y - (rect.y + rect.height / 2)];
			};
			updateCircle() {
				document.getElementById("circle-thing").style.transform = "translate(" + (Math.sin(this.angle * Math.PI / 180) * this.strength * 100) + "px, " + (Math.cos(this.angle * Math.PI / 180) * this.strength * 100) + "px)";
			};
		};
		Math.mod = function(a, b) {
			return ((a % b) + b) % b;
		};

		var playerX = 1.5;
		var playerY = 0;
		var playerXV = 0;
		var playerYV = 0;
		var cameraX = playerX * 50 - (canvas.width / 2);
		var cameraY = (playerY + 1) * -50 - (canvas.height / 2);
		var onGround = false;
		var seeds = [];
		var imagesLoaded = 0;
		var images = {
			guy: new CanvasImage("rgb(255, 255, 255)", "https://t4.ftcdn.net/jpg/01/73/40/15/360_F_173401516_HH7aV0os9LEum5ayYNrtoovV1jYrt561.jpg"),
			skyDay: new CanvasImage("rgb(200, 200, 255)", "https://media.hswstatic.com/eyJidWNrZXQiOiJjb250ZW50Lmhzd3N0YXRpYy5jb20iLCJrZXkiOiJnaWZcL3doeS1pcy1za3ktYmx1ZS5qcGciLCJlZGl0cyI6eyJyZXNpemUiOnsid2lkdGgiOjgyOH19fQ=="),
			grass: new CanvasImage("rgb(0, 200, 0)", "https://images.pexels.com/photos/413195/pexels-photo-413195.jpeg?cs=srgb&dl=pexels-pixmike-413195.jpg&fm=jpg"),
			hills: new CanvasImage("rgb(0, 150, 0)", "https://upload.wikimedia.org/wikipedia/commons/thumb/2/28/Chocolate_Hills_overview.JPG/1200px-Chocolate_Hills_overview.JPG"),
			ice: new CanvasImage("rgb(220, 220, 255)", "https://media.istockphoto.com/id/466513257/photo/image-of-light-blue-ice-design.jpg?s=612x612&w=0&k=20&c=tkgdD6LDAjjDL-J_OCc2tkN924FLtjvgSeQWgVBY5-Y="),
			snow: new CanvasImage("rgb(250, 250, 250)", "https://t4.ftcdn.net/jpg/00/73/39/95/360_F_73399559_6z3WIVyR5fPvXAW96ZFG1RBHsz6qVn4R.jpg"),
			dirt: new CanvasImage("rgb(128, 128, 0)", "https://upload.wikimedia.org/wikipedia/commons/thumb/8/8a/Dirt.JPG/640px-Dirt.JPG"),
			stones: new CanvasImage("rgb(200, 200, 200)", "https://d3mvlb3hz2g78.cloudfront.net/wp-content/uploads/2016/01/thumb_720_450_f_28.jpg"),
			stone: new CanvasImage("rgb(140, 140, 140)", "https://media.istockphoto.com/photos/light-grey-black-slate-stone-background-or-texture-picture-id1164746310?b=1&k=20&m=1164746310&s=612x612&w=0&h=nj0fWpCXBGNXhcUuWhXIF3HmcZiXMagkQ-DyPHAXLiw="),
			darkStone: new  CanvasImage("rgb(80, 80, 80)", "https://media.istockphoto.com/id/1136387527/photo/black-gray-grunge-background-dirty-concrete-wall-stucco-vintage-rock-texture-ombre-dark-stone.jpg?b=1&s=170667a&w=0&k=20&c=iUFh6s42MVX40KVd7bmkfcPHtMjYvqNsVndFQ2dMFWY="),
			stoneBackground: new CanvasImage("rgb(100, 100, 100)", "https://img.freepik.com/premium-photo/cave-wall-background_181627-531.jpg?w=2000"),
			packedSnow: new CanvasImage("rgb(120, 120, 150)", "https://thumbs.dreamstime.com/b/snow-surface-full-frame-background-texture-pattern-14970280.jpg"),
			magma: new CanvasImage("rgb(180, 70, 70)", "https://media.wired.co.uk/photos/606da0c989f3babb1f0133fb/master/w_1600%2Cc_limit/Lava.jpg"),
			lava: new CanvasImage("rgb(220, 0, 0)", "https://3docean.img.customer.envatousercontent.com/files/371574722/Image+Preview.jpg?auto=compress%2Cformat&fit=crop&crop=top&w=590&h=590&s=dc0fcc220b7f9d9b06eedf277f6f0844"),
			coin: new CanvasImage("rgb(255, 255, 0)", "https://m.media-amazon.com/images/I/51VLhMGtaTL._AC_SY1000_.jpg"),
			gem: new CanvasImage("rgb(150, 150, 255)", "https://cdn.britannica.com/78/170778-131-D35E060F/Reflections-diamond.jpg"),
			mysteryCrate: new CanvasImage("rgb(200, 200, 0)", "https://thumbs.dreamstime.com/b/crate-question-10722232.jpg"),
			ladder: new CanvasImage("rgb(200, 200, 160)", "https://m.media-amazon.com/images/I/71l4pWDxfTL.jpg"),
			guyJumping: new CanvasImage("rgb(255, 255, 255)", "https://thumbs.dreamstime.com/b/young-businessman-jumping-excitement-full-length-shot-isolated-white-background-156089211.jpg"),
			guyRunning: new CanvasImage("rgb(255, 255, 255)", "https://d2gg9evh47fn9z.cloudfront.net/800px_COLOURBOX3059374.jpg"),
			guyClimbingLadder: new CanvasImage("rgb(255, 255, 255)", "https://thumbs.dreamstime.com/b/businessman-climbing-ladder-8490148.jpg"),
			guyFalling: new CanvasImage("rgb(255, 255, 255)", "https://media.istockphoto.com/id/1297454782/photo/businessman-falling-down-isolated.jpg?s=612x612&w=0&k=20&c=UwgYtYVhktnHcYOHovzWOD3oZT1JNrguZcl5cQCKEGw="),
			guyDead: new CanvasImage("rgb(255, 200, 200)", "https://as1.ftcdn.net/v2/jpg/00/47/51/36/1000_F_47513651_NvfOZ1VY0YQwXriVuQKDCE6XLueitq57.jpg"),
			guyFlying: new CanvasImage("rgb(255, 255, 255)", "https://thumbs.dreamstime.com/b/flying-businessman-happy-high-isolated-white-37045715.jpg"),
			sentry: new CanvasImage("rgb(15, 15, 15)", "https://forums.rpgmakerweb.com/data/attachments/182/182633-4abbd801946b4603beb05c7c7c9e81a2.jpg"),
			sentryBarracks: new CanvasImage("rgb(170, 200, 170)", "https://images.fineartamerica.com/images/artworkimages/mediumlarge/2/abandoned-shack-in-woods-douglas-barnett.jpg"),
			pitfall: new CanvasImage("128, 128, 50", "https://content.instructables.com/FJL/5NV5/FV4LSDNT/FJL5NV5FV4LSDNT.jpg?auto=webp&fit=bounds&frame=1"),
			skyNight: new CanvasImage("rgb(0, 0, 0)", "https://images.unsplash.com/photo-1528818955841-a7f1425131b5?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8NHx8c3RhcnJ5JTIwc2t5fGVufDB8fDB8fA%3D%3D&w=1000&q=80"),
			moon: new CanvasImage("rgb(70, 170, 170)", "https://bigthink.com/wp-content/uploads/2020/10/origin-26.jpg"),
			ironNickelAlloy: new CanvasImage("rgb(210, 210, 210)", "https://cdn.openpr.com/R/b/Rb1218790_g.jpg"),
			mimic: new CanvasImage("rgb(240, 240, 240)", "https://www.halloweenforum.com/attachments/large-jpg.524714/")
		};
		var layers = {
			"-7": [images.ironNickelAlloy, 0.85],
			"-6": [images.lava, 0.9],
			"-5": [images.magma, 0.77],
			"-4": [images.darkStone, 0.65],
			"-3": [images.stone, 0.7],
			"-2": [images.stones, 0.75],
			"-1": [images.dirt, 0.8],
			"0": [images.grass, 0.75],
			"1": [images.stone, 0.65],
			"2": [images.snow, 0.9],
			"3": [images.ice, 0.96],
			"4": [images.moon, 0.7]
		};
		var level = {
			rows: [],
			originalRows: [],
			features: [],
			octaves: [],
		};
		var coins = 0;
		var gems = 0;
		var fac = 
			"Marina silva is a brazilian politician and an activist for deforestation and other things. She was a rubber tapper and found that land was being invaded by rubber tappers and she started protecting thousands of hectares of land."
		;
		var facasd = false;
		var shop = false;
		var bootses = {
			"sketchers": {bought: true, cost: 0},
			"tennis rackets": {bought: false, cost: 30},
			"running shoes": {bought: false, cost: 60},
			"spring boots": {bought: false, cost: 90},
			"feather boots": {bought: false, cost: 120},
			"stepping boots": {bought: false, cost: 150},
			"magnet boots": {bought: false, cost: 170}
		};
		var foods = {
			"apple": {cost: 5, hunger: 0.1, howmany: 0},
			"bread": {cost: 10, hunger: 0.2, howmany: 0},
			"burger": {cost: 14, hunger: 0.3, howmany: 0},
			"cold meal": {cost: 19, hunger: 0.4, howmany: 0},
			"meal": {cost: 23, hunger: 0.5, howmany: 0},
			"warm meal": {cost: 27, hunger: 0.6, howmany: 0},
			"hot meal": {cost: 31, hunger: 0.7, howmany: 0},
			"crispy gooey homemade mac and cheese": {cost: 34, hunger: 0.8, howmany: 0},
			"cow brain": {cost: 38, hunger: 0.9, howmany: 0},
			"filling warm meal": {cost: 41, hunger: 1, howmany: 0}
		};
		var potions = {
			"speed potion": {cost: 2, time: 0, duration: 10, howmany: 0},
			"jumping potion": {cost: 3, time: 0, duration: 10, howmany: 0},
			"regeneration potion": {cost: 5, time: 0, duration: 10, howmany: 0},
			"spider potion": {cost: 7, time: 0, duration: 10, howmany: 0},
			"levitation potion": {cost: 8, time: 0, duration: 10, howmany: 0},
			"bird potion": {cost: 12, time: 0, duration: 10, howmany: 0}
		};
		var boots = "sketchers";
		var health = 1;
		var dead = false;
		var ladders = 0;
		var inLadder = false;
		var joystick = new Joystick(document.getElementById("joystick"));
		var controls = {
			up: false,
			down: false,
			left: false,
			right: false
		};
		var tallLadders = 0;
		var score = 0;
		var fps = 0;
		var startFrameTime = 0;
		var endFrameTime = 0;
		var flying = false;
		var pb = 0;
		var mobs = [];
		var notification = "";
		var notificationTime = 0;
		var gameTime = 0;
		var blockSize = 50;

		for (let i = 0; i < 5; i++) {
			level.octaves.push(perlinNoise1D());
		};
		function generateLevel() {
			let oldLength = level.rows.length;//rows.length == 0 ? -1 : rows.length;
			for (let i = oldLength; i < oldLength + 1000; i++) {
				let perlinHeight = 0;
				for (let j = 0; j < level.octaves.length; j++) {
					perlinHeight += ((perlinGetVal(level.octaves[j], i / 10) - 0.5) * 4) / (2 ** j);
				};
				level.rows[i] = level.originalRows[i] = (level.rows[i - 1] ?? 0) + perlinHeight; // (Math.floor(Math.random() * 7) - 3);
			};

			// round stuff and coins n gems
			for (let i = oldLength; i < oldLength + 1000; i++) {// 0-air 1-coin 2-gem 3-ladder 4-tallladder 5-wall 6-mysterycrate 7-sentrybarracks 8-sentrybarracksnosentry 9-pitfall
				level.rows[i] = level.originalRows[i] = Math.round(level.rows[i]);
				let pool = [];
				if (Math.random() < 0.05) pool.push(1);
				if (Math.random() < 0.005) pool.push(2);
				if (Math.random() < 0.001) pool.push(6);
				if (Math.random() < 0.0002) pool.push(5);
				if (Math.random() < 0.0001) pool.push(7);
				if (Math.random() < 0.025 && new Set([level.rows[i - 2], level.rows[i - 1], level.rows[i], Math.round(level.rows[i + 1]), Math.round(level.rows[i + 2])]).size == 1) pool.push(9);
				level.features[i] = pool.length == 0 ? 0 : pool[Math.floor(Math.random() * pool.length)];
			};
		};
		generateLevel();
		playerY = level.rows[1];
		function getHittableRows(x) {
			hittableRows = [];
			if (Math.mod(x, 1) < 0.5) {
				hittableRows.push(Math.floor(x) - 1);
			};
			hittableRows.push(Math.floor(x));
			if (Math.mod(x, 1) > 0.5) {
				hittableRows.push(Math.floor(x) + 1);
			};
			return hittableRows;
		};
		function getLayer(y) {
			return Math.floor(y / 100);
		};
		function clamp(number, min, max) {
			return Math.min(Math.max(number, min), max);
		};
		function lerp(a, b, c) {
			return a * (1 - c) + b * c;
		};

		function perlinNoise1D() {
			let MAX_VERTICES = 512;
			let r = [];
			for (let i = 0; i < MAX_VERTICES; ++i) {
				r.push(Math.random()); // mulberry32(i + 100));
			};
			return {MAX_VERTICES, r};
		};
		function perlinGetVal(generator, x) {
			let t = x - Math.floor(x);
			let tRemapSmoothstep = t ** 2 * (3 - 2 * t);
			let xMin = Math.floor(x) & (generator.MAX_VERTICES - 1);
			let xMax = (xMin + 1) & (generator.MAX_VERTICES - 1);
			return lerp(generator.r[xMin], generator.r[xMax], tRemapSmoothstep);
		};
		function mulberry32(a) {
			let t = a += 0x6D2B79F5;
			t = Math.imul(t ^ t >>> 15, t | 1);
			t ^= t + Math.imul(t ^ t >>> 7, t | 61);
			return ((t ^ t >>> 14) >>> 0) / 4294967296;
		};
		function shopButton() {
			if (shop = !shop) {
				document.getElementById("shop").style.display = "block";
			} else {
				document.getElementById("shop").style.display = "none";
				document.getElementById("canvas-wrapper").focus();
			};
		};
		function clickShoeButton(button, bootsreal) {
			if (bootses[bootsreal].bought) {
				boots = bootsreal;
			} else {
				if (coins >= bootses[bootsreal].cost) {
					bootses[bootsreal].bought = true;
					coins -= bootses[bootsreal].cost
				} else {
					alert("bankrupt");
				};
			};
		};
		function purchaseFood(food) {
			if (coins >= foods[food].cost) {
				foods[food].howmany++;
				coins -= foods[food].cost;
			} else {
				alert("bankrupt");
			};
		};
		function devourFood(food) {
			if (foods[food].howmany >= 1) {
				foods[food].howmany--;
				health += foods[food].hunger;
				health = clamp(health, 0, 1);
			};
		};
		function keyDownFunction(e) {
			if (e.repeat) return;
			keysDown[e.key] = true;
			if (e.key == "t") {
				facasd = true;
				setTimeout(() => {
					facasd = false;
				}, 3000);
			} else if (e.key == "l") {
				level.rows = JSON.parse(prompt("what level rows"));
			} else if (e.key == "r") {
				playerXV = 0;
				playerYV = 0;
				playerX = 1.5;
				playerY = level.rows[1] ?? 0;
			};
		};
		function purchaseLadder() {
			if (coins >= 10) {
				coins -= 10;
				ladders++;
			} else {
				alert("bankrupt");
			};
		};
		function placeLadder() {
			if (ladders >= 1 && level.features[Math.floor(playerX)] == 0) {
				level.features[Math.floor(playerX)] = 3;
				ladders--;
			};
		};
		function purchaseTallLadder() {
			if (coins >= 25) {
				coins -= 25;
				tallLadders++;
			} else {
				alert("bankrupt");
			};
		};
		function placeTallLadder() {
			if (tallLadders >= 1 && level.features[Math.floor(playerX)] == 0) {
				level.features[Math.floor(playerX)] = 4;
				tallLadders--;
			};
		};
		function brewPotion(potion) {
			if (gems >= potions[potion].cost) {
				potions[potion].howmany++;
				gems -= potions[potion].cost;
			} else {
				alert("bankrupt");
			};
		};
		function chugPotion(potion) {
			if (potions[potion].howmany >= 1) {
				potions[potion].howmany--;
				potions[potion].time += potions[potion].duration;
			};
		};
		Array.prototype.random = function() {
			return this[Math.floor(Math.random() * this.length)];
		};
		function saveSlot(slot) {
			try{
			let saveCode = JSON.stringify({
				level,
				playerX,
				playerY,
				playerXV,
				playerYV,
				coins,
				gems,
				ladders,
				tallLadders,
				health,
				dead,
				bootses,
				boots,
				foods,
				potions,
				pb,
				mobs,
				gameTime
			});
			localStorage.setItem("forestSimulator3DSaveSlot" + slot, saveCode);
		} catch(e) {alert(e.stack)}
		};
		function loadSlot(slot) {
			let saveCode = localStorage.getItem("forestSimulator3DSaveSlot" + slot);
			if (saveCode === null) {
				alert("save slot " + slot + " empty, to create a new save slot reload and press save in the new one you want to create")
			} else {
				saveCode = JSON.parse(saveCode);
				level = saveCode.level ?? level;
				playerX = saveCode.playerX ?? playerX;
				playerY = saveCode.playerY ?? playerY;
				playerXV = saveCode.playerYV ?? playerXV;
				coins = saveCode.coins ?? coins;
				gems = saveCode.gems ?? gems;
				ladders = saveCode.ladders ?? ladders;
				tallLadders = saveCode.tallLadders ?? tallLadders;
				health = saveCode.health ?? health;
				dead = saveCode.dead ?? dead;
				bootses = saveCode.bootses ?? bootses;
				boots = saveCode.boots ?? boots;
				foods = saveCode.foods ?? foods;
				potions = saveCode.potions ?? potions;
				pb = saveCode.pb ?? pb;
				mobs = saveCode.mobs ?? mobs;
				gameTime = saveCode.gameTime ?? gameTime;
			};
		};
		function clearSlot(slot) {
			localStorage.removeItem("forestSimulator3DSaveSlot" + slot);
		};
		function clearAllSlots() {
			localStorage.clear();
		};
		function spawnMob(mob, x, y) {
			mobs.push({
				type: mob,
				x: x,
				y: y,
				age: 0
			});
		};
		function notificate(message) {
			notification = message;
			notificationTime = 180;
		};

		function tick() {
			document.getElementById("joystick").style.display = document.getElementById("joystick-checkbox").checked ? "flex" : "none";
			controls.up = isDown("ArrowUp") || isDown("w") || (joystick.strength > 0.5 && (joystick.angle > 112.5 || joystick.angle < -112.5));
			controls.down = isDown("ArrowDown") || isDown("s") || (joystick.strength > 0.5 && (joystick.angle > -67.5 && joystick.angle < 67.5));
			controls.left = isDown("ArrowLeft") || isDown("a") || (joystick.strength > 0.5 && (joystick.angle > -157.5 && joystick.angle < -22.5));
			controls.right = isDown("ArrowRight") || isDown("d") || (joystick.strength > 0.5 && (joystick.angle > 22.5 && joystick.angle < 157.5));
			if (!shop && !dead) {
				if (playerX >= level.rows.length) {
					generateLevel();
				};
				let bakedRows = [...level.rows].map((it, i) => it + (level.features[i] == 5) * 5);
				gameTime += 1/60;

				for (let potion in potions) {
					potions[potion].time = Math.max(potions[potion].time - (1 / 60), 0);
				};
				flying = potions["bird potion"].time > 0;
				let playerSpeed = 0.2 + (boots == "running shoes") * 0.04 + (potions["speed potion"].time > 0) * 0.1;
				if (controls.right != controls.left) {
					let sign = controls.right - controls.left;
					playerXV = inLadder ? sign * (boots == "magnet boots" ? 0 : 0.1) : (flying ? sign * 0.3 : (sign * playerSpeed + (sign * 0.04 * (controls.up && onGround))));
				};
				playerX += playerXV;
				let hittableRows;
				let playerColliding = () => {
					hittableRows = getHittableRows(playerX);
					return (hittableRows[0] != undefined && bakedRows[hittableRows[0]] > playerY) || (hittableRows[1] != undefined && bakedRows[hittableRows[1]] > playerY);
				};

				if (playerColliding()) {
					let max = getHittableRows(playerX).reduce((a, b) => bakedRows[a] > bakedRows[b] ? a : b);
					if (onGround && playerY >= bakedRows[max] - (boots == "stepping boots" ? 1 : 0.5) && potions["spider potion"].time <= 0) {
						playerY = bakedRows[max];
					} else {
						playerX = Math.ceil(playerX) - 0.5;
						playerXV = 0;
						if (potions["spider potion"].time > 0) {
							playerYV = 0;
							playerY += 0.2;
						};
					};
				};
				if (inLadder) {
					playerYV = (controls.down - controls.up) * (boots == "magnet boots" ? 0 : -0.1);
				} else if (flying) {
					if (controls.up != controls.down) {
						playerYV = (controls.down - controls.up) * 0.3;
					};
					playerYV *= 0.99;
				} else {
					let jumpHeight = 0.24 + (boots == "spring boots") * 0.06 + (potions["jumping potion"].time > 0) * 0.08;
					playerYV += controls.up * onGround * (jumpHeight + Math.abs(playerXV) * 0.15);
				};
				playerY += playerYV;
				hittableRows = getHittableRows(playerX);
				let max = hittableRows.reduce((a, b) => bakedRows[a] > bakedRows[b] ? a : b);
				let oldOnGround = onGround;
				onGround = playerY < bakedRows[max];
				if (!oldOnGround && onGround && playerYV > 30) {
					health -= playerYV * 0.001;
				};
				if (onGround) {
					if (getLayer(level.rows[max]) == 2 && level.rows[max] - 200 > (level.originalRows[max] - 200) * 0.9 && boots != "tennis rackets") {
						level.rows[max] -= 0.005;
					};
					playerY = bakedRows[max];
					playerYV = 0;
				};
				let oldInLadder = inLadder;
				inLadder = false;
				for (let i = 0; i < level.features.length; i++) {
					if (playerX + 0.5 > i && playerX - 0.5 < i + 1) {
						if (playerY < bakedRows[i] + 1) {
							switch (level.features[i]) {
								case 2:
									gems++;
									level.features[i] = 0;
									break;
								case 6:
									let crateOption = ["food", "potion", "ladder", "coins", "gems", "nothing"].random();
									let specific = null;
									switch (crateOption) {
										case "food":
											specific = Object.keys(foods).random();
											foods[specific].howmany++;
											break;
										case "potion":
											specific = Object.keys(potions).random();
											potions[specific].howmany++;
											break;
										case "ladder":
											specific = ["ladder", "tall ladder"].random();
											switch (specific) {
												case "ladder":
													ladders++;
													break;
												case "tall ladder":
													tallLadders++;
											};
											break;
										case "coins":
											specific = Math.floor(Math.random() * 19 + 1);
											coins += specific;
											break;
										case "gems":
											specific = Math.floor(Math.random() * 3 + 1);
											gems += specific;
											break;
										case "nothing":
											if (Math.random() < 1/100) {
												specific = "spawned 1000 sentries";
												for (let i = 0; i < 1000; i++) {
													spawnMob("sentry", Math.random() * level.rows.length, 0);
												};
											} else {
												specific = "get better";
											};
									};
									notificate("mystery crate opened! item: " + crateOption + " (" + specific + ")");
									level.features[i] = 0;
							};
						};
						if (level.features[i] == 1 && (boots == "magnet boots" || playerY < bakedRows[i] + 1)) {
							coins++;
							level.features[i] = 0;
						};
						if ((playerY < bakedRows[i] + 4 && level.features[i] == 3) || (playerY < bakedRows[i] + 6 && level.features[i] == 4)) {
							inLadder = true;
						};
						if (inLadder != oldInLadder) {
							playerXV = 0;
							playerYV = 0;
						};
						if (playerY < bakedRows[i] + 3 && level.features[i] == 7) {
							spawnMob("sentry", playerX, playerY);
							level.features[i] = 8;
						};
						if (onGround && playerY == bakedRows[i] && boots !== "tennis rackets" && level.features[i] == 9) {
							level.rows[i - 1] = level.rows[i] = level.rows[i + 1] = level.rows[i] - 4;
							level.features[i - 1] = 0;
							level.features[i] = 0;
							level.features[i + 1] = 0;
						};
					};
				};
				playerXV *= inLadder ? 0 : (onGround ? layers[clamp(getLayer(playerY), Math.min(...Object.keys(layers)), Math.max(...Object.keys(layers)))][1] : 0.99);
				playerYV = potions["levitation potion"].time > 0 ? 0.1 : (playerYV + ((inLadder || flying) ? 0 : ((boots == "magnet boots" && getLayer(playerY) == -7) ? -0.024 : -0.012)));
				if (boots == "feather boots") {
					playerYV = Math.min(playerYV, 15);
				};

				for (mob of mobs) {
					mob.age++;
					if (mob.type !== "sentry" || mob.age >= 120) {
						let xSign = Math.sign(playerX - mob.x)
						mob.x += xSign * 0.06;
						if (xSign !== Math.sign(playerX - mob.x)) {
							mob.x = playerX;
						};
						let sentryStepHeight = bakedRows[getHittableRows(mob.x).reduce((a, b) => bakedRows[a] > bakedRows[b] ? a : b)];
						if (sentryStepHeight - (mob.y) <= 3) {
							mob.y = sentryStepHeight;
						} else {
							mob.x = Math.ceil(mob.x) - 0.5;
						};
						if (mob.x + 0.5 > playerX - 0.5 && mob.x - 0.5 < playerX + 0.5 && playerY < mob.y + 4 && playerY + 2 > mob.y) {
							health -= 0.01;
						};
					};
				};

				cameraX = (cameraX * 3 + (playerX * 50 - canvas.width / 2)) / 4;
				cameraY = (cameraY * 3 + ((playerY + 1) * -50 - canvas.height / 2)) / 4;
				score = Math.max(score, Math.floor(playerX));
				pb = Math.max(pb, score);

				health += potions["regeneration potion"].time > 0 ? 0.0008 : -0.00008;
				health = clamp(health, 0, 1);
				dead = health <= 0;
				notificationTime = Math.max(0, notificationTime - 1);

				ctx.clearRect(0, 0, canvas.width, canvas.height);

				images[((gameTime % 600 < 300 && getLayer(playerY) < 4) ? "skyDay" : "skyNight")].draw(0, 0, canvas.width, canvas.height);
				
				if (cameraY > 200) {
					images.stoneBackground.draw(Math.mod(-cameraX, canvas.width * 4) / 4,					Math.mod(-cameraY, canvas.height * 4) / 4,					canvas.width, canvas.height);
					images.stoneBackground.draw(Math.mod(-cameraX, canvas.width * 4) / 4 - canvas.width,	Math.mod(-cameraY, canvas.height * 4) / 4,					canvas.width, canvas.height);
					images.stoneBackground.draw(Math.mod(-cameraX, canvas.width * 4) / 4,					Math.mod(-cameraY, canvas.height * 4) / 4 - canvas.height,	canvas.width, canvas.height);
					images.stoneBackground.draw(Math.mod(-cameraX, canvas.width * 4) / 4 - canvas.width,	Math.mod(-cameraY, canvas.height * 4) / 4 - canvas.height,	canvas.width, canvas.height);
				};
				
				images.hills.draw(0, 200, images.hills.image.width, images.hills.image.height - 200, Math.mod(-cameraX, canvas.width * 4) / 4, (200 - cameraY) / 4, canvas.width, canvas.height);
				images.hills.draw(0, 200, images.hills.image.width, images.hills.image.height - 200, Math.mod(-cameraX, canvas.width * 4) / 4 - canvas.width, (200 - cameraY) / 4, canvas.width, canvas.height);

				// grass
				let rowBuffer = Object.keys(level.rows).filter(it => it * 50 + 50 > cameraX && it * 50 < cameraX + canvas.width)
				for (let i = 0; i < rowBuffer.length; i++) {
					let ice = getLayer(level.rows[rowBuffer[i]]) == 2 && level.rows[rowBuffer[i]] - 100 < (level.originalRows[rowBuffer[i]] - 100) * 0.9;
					let groundImage = ice ? images.packedSnow : layers[clamp(getLayer(level.rows[rowBuffer[i]]), Math.min(...Object.keys(layers)), Math.max(...Object.keys(layers)))][0];
					let imageWidth = groundImage.image.height * (50 / (canvas.height * 2));
					let imageHeight = level.rows[rowBuffer[i]] * -50 - cameraY;
					groundImage.draw(Math.floor(((imageWidth * rowBuffer[i]) % (Math.floor(groundImage.image.width / imageWidth) * imageWidth)) / imageWidth) * imageWidth, 0, imageWidth, groundImage.image.height, rowBuffer[i] * 50 - cameraX, imageHeight, 50, canvas.height * 2);
					switch (level.features[rowBuffer[i]]) {
						case 1:
							images.coin.draw(rowBuffer[i] * 50 - cameraX, imageHeight - 50, 50, 50);
							break;
						case 2:
							images.gem.draw(rowBuffer[i] * 50 - cameraX, imageHeight - 50, 50, 50);
							break;
						case 3:
							images.ladder.draw(rowBuffer[i] * 50 - cameraX, imageHeight - 200, 50, 200);
							break;
						case 4:
							images.ladder.draw(rowBuffer[i] * 50 - cameraX, imageHeight - 300, 50, 300);
							break;
						case 5:
							images.stones.draw(rowBuffer[i] * 50 - cameraX, imageHeight - 250, 50, 250);
							break;
						case 6:
							images.mysteryCrate.draw(rowBuffer[i] * 50 - cameraX, imageHeight - 50, 50, 50);
							break;
						case 7:
							images.sentryBarracks.draw(rowBuffer[i] * 50 - cameraX, imageHeight - 150, 50, 150);
							break;
						case 8:
							images.sentryBarracks.draw(rowBuffer[i] * 50 - cameraX, imageHeight - 150, 50, 150);
							break;
						case 9:
							images.pitfall.draw(rowBuffer[i] * 50 - cameraX, imageHeight, 50, 25);
					};
				};
			
				let animatedGuyImage = dead ? "guyDead" : (inLadder ? "guyClimbingLadder" : (flying ? "guyFlying" : (onGround ? (Math.abs(playerXV) > 0.1 ? "guyRunning" : "guy") : (playerYV >= 0 ? "guyFalling" : "guyJumping"))));
				images[document.getElementById("animations-checkbox").checked ? animatedGuyImage : "guy"].draw(playerX * 50 - 25 - cameraX, playerY * -50 - 100 - cameraY, 50, 100);
				for (mob of mobs) {
					if (mob.type != "sentry" || mob.age >= 120) {
						images[mob.type].draw(mob.x * 50 - 25 - cameraX, mob.y * -50 - 200 - cameraY, 50, 200);
					};
				};
				ctx.font = "30px arial";
				ctx.fillStyle = "yellow";
				if (facasd) {
					ctx.fillText("Marina silva is a brazilian politician and an activist for deforestation and other things.", 0, 300);
					ctx.fillText("She was a rubber tapper and found that land was being invaded by rubber tappers and she", 0, 325);
					ctx.fillText("started protecting thousands of hectares of land.", 0, 350);
				};
			};
			let r = clamp(2 - health * 2, 0, 1) * 255;
			let g = clamp(health * 2, 0, 1) * 255;
			let b = (potions["regeneration potion"].time > 0) * 127;
			document.getElementById("health-inner").style.width = 600 * health + "px";
			document.getElementById("health-inner").style.backgroundColor = "rgb(" + r + ", " + g + ", " + b + ")";
			if (dead) {
				ctx.font = "100px arial";
				ctx.fillStyle = "red";
				ctx.fillText("you died", 200, 200);
			};
			document.getElementById("stats").innerHTML = "score: " + score + "<br>elevation: " + Math.floor(playerY) + "<br>coins: " + coins + "<br>gems: " + gems + "<br>boots: " + boots + "<br>frametime: " + Math.round(fps * 10000) / 10000 + "<br>sopx: " + playerXV + "<br>sopy: " + playerYV + "<br>camera x: " + cameraX + "<br>camera y: " + cameraY + "<br>onground: " + onGround;
			document.getElementById("notification").innerHTML = notificationTime > 0 ? notification : "";
			for (let food in foods) {
				document.getElementById(food.replaceAll(" ", "-") + "-howmany").innerHTML = "(" + foods[food].howmany + ")";
			};
			for (let potion in potions) {
				document.getElementById(potion.replaceAll(" ", "-") + "-howmany").innerHTML = "(" + potions[potion].howmany + ")";
			};
			document.getElementById("ladder-howmany").innerHTML = "(" + ladders + ")";
			document.getElementById("tall-ladder-howmany").innerHTML = "(" + tallLadders + ")";
		};
		function loop() {
			startFrameTime = performance.now();
			try {
				tick();
			} catch (e) {
				alert(e.stack);
				return;
			};
			endFrameTime = performance.now();
			fps = ((endFrameTime - startFrameTime) / 1000);
			requestAnimationFrame(loop);
		};
		loop();
		ctx.font = "100px arial";
		ctx.fillText("loading textures", 100, 100);
	</script>
</html>
