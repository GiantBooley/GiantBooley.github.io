<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>forest simulator 3d</title>
		<style>
			* {
				box-sizing: border-box;
			}
			html,body {
				width: 100%;
				height: 100%;
			}
			body {
				margin: 0;
				overflow: hidden;
			}
			#canvas-wrapper {
				width: 100%;
				height: 100%;
				outline: none;
			}
			#canvas {
				width: 100%;
				height: 100%;
			}
			#shop-button {
				position: absolute;
				top: 10px;
				right: 10px;
				color: black;
				background-color: white;
				border: 5px solid black;
				border-radius: 5px;
				padding: 10px;
				font-family: Arial, Helvetica, sans-serif;
				font-size: 20px;
			}
			#shop {
				display: none;
				position: absolute;
				left: 50%;
				top: 50%;
				transform: translate(-50%, -50%);
				width: 100px;
				height: 100px;
				background-color: white;
			}
			#stats {
				margin: 0;
				position: absolute;
				left: 10px;
				top: 2px;
				font-family: Arial, sans-serif;
				color: yellow;
				font-size: 30px;
			}
		</style>
	</head>
	<body>
		<div id="canvas-wrapper" tabindex="0" onkeydown="keysDown[event.key] = true; if (event.key=='t') facasd=true;setTimeout(()=>{facasd = false}, 3000)" onkeyup="keysDown[event.key] = false;">
			<canvas id="canvas"></canvas>
		</div>
		<div id="stats">score: -<br>coins: -</div>
		<button id="shop-button" onclick="shopButton();">SHOP</button>
		<div id="shop"></div>
	</body>
	<script>
		const canvas = document.getElementById("canvas");
		canvas.width = innerWidth;
		canvas.height = innerHeight;
		const ctx = canvas.getContext("2d");

		class Tree {
			constructor() {
				this
			};
		};

		var keysDown = [];
		function isDown(key) {
			return keysDown[key] ?? false;
		};
		class CanvasImage {
			constructor(src) {
				this.image = new Image();
				this.image.src = src;
				this.loaded = false;
				let canvasimagething = this;
				this.image.onload = function() {
					canvasimagething.loaded = true;
					imagesLoaded++;
					if (imagesLoaded == Object.keys(images).length) {
						loop();
					}; 
				};
			};
		};
		Math.mod = function(a, b) {
			return ((a % b) + b) % b;
		};

		var playerX = 100;
		var playerY = -900;
		var playerXV = 0;
		var playerYV = 0;
		var cameraX = 0;
		var cameraY = 0;
		var onGround = false;
		var seeds = [];
		var imagesLoaded = 0;
		var images = {
			guy: new CanvasImage("https://t4.ftcdn.net/jpg/01/73/40/15/360_F_173401516_HH7aV0os9LEum5ayYNrtoovV1jYrt561.jpg"),
			sky: new CanvasImage("https://media.hswstatic.com/eyJidWNrZXQiOiJjb250ZW50Lmhzd3N0YXRpYy5jb20iLCJrZXkiOiJnaWZcL3doeS1pcy1za3ktYmx1ZS5qcGciLCJlZGl0cyI6eyJyZXNpemUiOnsid2lkdGgiOjgyOH19fQ=="),
			grass: new CanvasImage("https://images.pexels.com/photos/413195/pexels-photo-413195.jpeg?cs=srgb&dl=pexels-pixmike-413195.jpg&fm=jpg"),
			hills: new CanvasImage("https://upload.wikimedia.org/wikipedia/commons/thumb/2/28/Chocolate_Hills_overview.JPG/1200px-Chocolate_Hills_overview.JPG"),
			ice: new CanvasImage("https://media.istockphoto.com/id/466513257/photo/image-of-light-blue-ice-design.jpg?s=612x612&w=0&k=20&c=tkgdD6LDAjjDL-J_OCc2tkN924FLtjvgSeQWgVBY5-Y="),
			snow: new CanvasImage("https://t4.ftcdn.net/jpg/00/73/39/95/360_F_73399559_6z3WIVyR5fPvXAW96ZFG1RBHsz6qVn4R.jpg"),
			dirt: new CanvasImage("https://upload.wikimedia.org/wikipedia/commons/thumb/8/8a/Dirt.JPG/640px-Dirt.JPG"),
			stones: new CanvasImage("https://d3mvlb3hz2g78.cloudfront.net/wp-content/uploads/2016/01/thumb_720_450_f_28.jpg"),
			stone: new CanvasImage("https://media.istockphoto.com/photos/light-grey-black-slate-stone-background-or-texture-picture-id1164746310?b=1&k=20&m=1164746310&s=612x612&w=0&h=nj0fWpCXBGNXhcUuWhXIF3HmcZiXMagkQ-DyPHAXLiw="),
			darkStone: new  CanvasImage("https://media.istockphoto.com/id/1136387527/photo/black-gray-grunge-background-dirty-concrete-wall-stucco-vintage-rock-texture-ombre-dark-stone.jpg?b=1&s=170667a&w=0&k=20&c=iUFh6s42MVX40KVd7bmkfcPHtMjYvqNsVndFQ2dMFWY="),
			stoneBackground: new CanvasImage("https://img.freepik.com/premium-photo/cave-wall-background_181627-531.jpg?w=2000"),
			packedSnow: new CanvasImage("https://thumbs.dreamstime.com/b/snow-surface-full-frame-background-texture-pattern-14970280.jpg"),
			magma: new CanvasImage("https://media.wired.co.uk/photos/606da0c989f3babb1f0133fb/master/w_1600%2Cc_limit/Lava.jpg"),
			lava: new CanvasImage("https://3docean.img.customer.envatousercontent.com/files/371574722/Image+Preview.jpg?auto=compress%2Cformat&fit=crop&crop=top&w=590&h=590&s=dc0fcc220b7f9d9b06eedf277f6f0844"),
			coin: new CanvasImage("https://m.media-amazon.com/images/I/51VLhMGtaTL._AC_SY1000_.jpg")
		};
		var layers = {
			"-6": [images.lava.image, 0.9],
			"-5": [images.magma.image, 0.77],
			"-4": [images.darkStone.image, 0.65],
			"-3": [images.stone.image, 0.7],
			"-2": [images.stones.image, 0.75],
			"-1": [images.dirt.image, 0.8],
			"0": [images.grass.image, 0.75],
			"1": [images.stone.image, 0.65],
			"2": [images.snow.image, 0.9],
			"3": [images.ice.image, 0.96]
		};
		//=================//
		// -==ROW STUFF=-- //
		//=================//
		var rows = {};
		var octaves = [];
		for (let i = 0; i < 5; i++) {
			octaves.push(new Simple1DNoise());
		};
		for (let i = 0; i < 10000; i++) {
			let perlinHeight = 0;
			for (let j = 0; j < octaves.length; j++) {
				perlinHeight += ((octaves[j].getVal(i / 10) - 0.5) * 3) / (2 ** j);
			};
			rows[i] = (rows[i - 1] ?? 0) + perlinHeight; // (Math.floor(Math.random() * 7) - 3);
		};
		for (row in Object.keys(rows)) {
			rows[row] = Math.floor(rows[row]);
		};
		var originalRows = structuredClone(rows);

		var coinPositions = new Uint8ClampedArray(Object.keys(rows).length);
		var coins = 0;
		for (let i = 0; i < Object.keys(rows).length; i++) {
			coinPositions[i] = Math.random() < 0.05 ? 1 : 0;
		};
		var fac = 
			"Marina silva is a brazilian politician and an activist for deforestation and other things. She was a rubber tapper and found that land was being invaded by rubber tappers and she started protecting thousands of hectares of land."
		;
		var facasd = false;
		var shop = false;


		function getHittableRows() {
			hittableRows = [Math.floor(playerX / 50)];
			if (Math.mod(playerX, 50) > 25) {
				hittableRows.push(Math.floor(playerX / 50) + 1);
			};
			if (Math.mod(playerX, 50) < 25) {
				hittableRows.push(Math.floor(playerX / 50) - 1);
			};
			return hittableRows;
		};
		function getLayer(y) {
			return Math.floor(y / 100);
		};
		function clamp(number, min, max) {
			return Math.min(Math.max(number, min), max);
		};
		function lerp(a, b, c) {
			return a * (1 - c) + b * c;
		};
		function Simple1DNoise() {
			let MAX_VERTICES = 256;
			let MAX_VERTICES_MASK = MAX_VERTICES -1;
			let amplitude = 1;
			let scale = 1;

			let r = [];

			for (let i = 0; i < MAX_VERTICES; ++i) {
				r.push(Math.random()); // mulberry32(i + 100));
			};
		
			var getVal = function(x){
				let scaledX = x * scale;
				let xFloor = Math.floor(scaledX);
				let t = scaledX - xFloor;
				let tRemapSmoothstep = t * t * (3 - 2 * t);
			
				/// Modulo using &#038;
				let xMin = xFloor & MAX_VERTICES_MASK;
				let xMax = ( xMin + 1 ) & MAX_VERTICES_MASK;
			
				let y = lerp(r[xMin], r[xMax], tRemapSmoothstep);
			
				return y * amplitude;
			};
		
			// return the API
			return {
				getVal: getVal,
				setAmplitude: function(newAmplitude) {
					amplitude = newAmplitude;
				},
				setScale: function(newScale) {
					scale = newScale;
				}
			};
		};
		function mulberry32(a) {
			let t = a += 0x6D2B79F5;
			t = Math.imul(t ^ t >>> 15, t | 1);
			t ^= t + Math.imul(t ^ t >>> 7, t | 61);
			return ((t ^ t >>> 14) >>> 0) / 4294967296;
		};
		function shopButton() {
			if (shop = !shop) {
				document.getElementById("shop").style.display = "block";
			} else {
				document.getElementById("shop").style.display = "none";
			};
		};

		function loop() {
			if (!shop) {
				playerXV += (isDown("ArrowRight") - isDown("ArrowLeft")) * (2 + (isDown("ArrowUp") && onGround) * 5);
				playerYV += isDown("ArrowUp") * onGround * (-12 - (Math.abs(playerXV)) * 0.15);
				//playerYV += isDown("d") * -15 * onGround;
				//playerYV += isDown("f") * -20 * onGround;
				playerX += playerXV;
				let hittableRows = getHittableRows();
				if (rows[hittableRows[0]] * -50 < playerY + 50 || rows[hittableRows[1]] * -50 < playerY + 50 || rows[hittableRows[2]] * -50 < playerY + 50) {
					playerX -= playerXV;
					//playerY -= 50;
					playerXV = 0;
				};
				playerY += playerYV;
				hittableRows = getHittableRows();
				let max = hittableRows.reduce((a, b) => rows[a] > rows[b] ? a : b);
				onGround = playerY > rows[max] * -50 - 50;
				if (onGround) {
					if (getLayer(rows[max]) == 2 && rows[max] - 200 > (originalRows[max] - 200) * 0.9) {
						rows[max] -= 0.05;
					};
					playerY -= playerYV;
					playerYV = 0;
				};
				for (let i = 0; i < coinPositions.length; i++) {
					if (coinPositions[i] == 1 && playerX / 50 + 0.5 > i && playerX / 50 - 0.5 < i + 1 && playerY / -50 - 1 < rows[i] + 1) {
						coinPositions[i] = 0;
						coins++;
					};
				};
				playerXV *= onGround ? layers[clamp(getLayer(playerY / -50), Math.min(...Object.keys(layers)), Math.max(...Object.keys(layers)))][1] : 0.8;
				playerYV += 0.6;
				cameraX = (cameraX * 3 + (playerX - canvas.width / 2)) / 4;
				cameraY = (cameraY * 3 + (playerY - canvas.height / 2)) / 4;

				ctx.clearRect(0, 0, canvas.width, canvas.height);

				ctx.drawImage(images.sky.image, 0, 0, canvas.width, canvas.height);
				//if (cameraY > -250) {
					//ctx.drawImage(images.stoneBackground.image, Math.mod(-cameraX, canvas.width * 4) / 4,					Math.mod(-cameraY, canvas.height),					canvas.width, canvas.height);
					//ctx.drawImage(images.stoneBackground.image, Math.mod(-cameraX, canvas.width * 4) / 4 - canvas.width,	Math.mod(-cameraY, canvas.height),					canvas.width, canvas.height);
					//ctx.drawImage(images.stoneBackground.image, Math.mod(-cameraX, canvas.width * 4) / 4,					Math.mod(-cameraY, canvas.height) - canvas.height,	canvas.width, canvas.height);
					//ctx.drawImage(images.stoneBackground.image, Math.mod(-cameraX, canvas.width * 4) / 4 - canvas.width,	Math.mod(-cameraY, canvas.height) - canvas.height,	canvas.width, canvas.height);
				//};
				
				ctx.drawImage(images.hills.image, 0, 200, images.hills.image.width, images.hills.image.height - 200, Math.mod(-cameraX, canvas.width * 4) / 4, (200 - cameraY) / 4, canvas.width, 500);
				ctx.drawImage(images.hills.image, 0, 200, images.hills.image.width, images.hills.image.height - 200, Math.mod(-cameraX, canvas.width * 4) / 4 - canvas.width, (200 - cameraY) / 4, canvas.width, 500);

				// grass
				let rowBuffer = Object.keys(rows).map(it=>parseInt(it)).filter(it => it * 50 + 50 > cameraX && it * 50 < cameraX + canvas.width)
				for (let i = 0; i < rowBuffer.length; i++) {
					let ice = getLayer(rows[rowBuffer[i]]) == 2 && rows[rowBuffer[i]] - 100 < (originalRows[rowBuffer[i]] - 100) * 0.9;
					let groundImage = ice ? images.packedSnow.image : layers[clamp(getLayer(rows[rowBuffer[i]]), Math.min(...Object.keys(layers)), Math.max(...Object.keys(layers)))][0];
					let imageWidth = groundImage.height * (50 / (canvas.height * 2));
					let imageHeight = rows[rowBuffer[i]] * -50 - cameraY;
					ctx.drawImage(groundImage, Math.floor(((imageWidth * rowBuffer[i]) % (Math.floor(groundImage.width / imageWidth) * imageWidth)) / imageWidth) * imageWidth, 0, imageWidth, groundImage.height, rowBuffer[i] * 50 - cameraX, imageHeight, 50, canvas.height * 2);
					if (coinPositions[rowBuffer[i]] == 1) {
						ctx.drawImage(images.coin.image, rowBuffer[i] * 50 - cameraX, imageHeight - 50, 50, 50);
					};
				};
			
				ctx.drawImage(images.guy.image, playerX - 25 - cameraX, playerY - 50 - cameraY, 50, 100);
				ctx.font = "30px arial";
				ctx.fillStyle = "yellow";
				if (facasd) {
					ctx.fillText("Marina silva is a brazilian politician and an activist for deforestation and other things.", 0, 300);
					ctx.fillText("She was a rubber tapper and found that land was being invaded by rubber tappers and she", 0, 325);
					ctx.fillText("started protecting thousands of hectares of land.", 0, 350);
				};
			};
			document.getElementById("stats").innerHTML = "score: " + Math.floor(playerX / 50) + "<br>coins: " + coins;

			requestAnimationFrame(loop);
		};
		ctx.font = "100px arial";
		ctx.fillText("loading textures", 100, 100);
	</script>
</html>
